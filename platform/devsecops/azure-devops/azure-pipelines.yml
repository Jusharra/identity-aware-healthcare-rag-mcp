trigger:
  branches:
    include:
      - main
      - feature/*

variables:
  TF_ROOT: "platform/devsecops/terraform/evidence_storage_azure"
  PYTHON_VERSION: "3.11"

   # ðŸ” Azure subscription context for Terraform (used in PolicyCheck)
  SUBSCRIPTION_ID: "ef83b64d-39a9-4b0f-af33-06968ebd9a0a"
  TENANT_ID: "0ff0f2e4-1bd5-4dca-bcc0-ea9dbaf4ea47"

stages:
  - stage: Validate
    displayName: "Validate Terraform & Python"
    jobs:
      - job: validate
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: "$(PYTHON_VERSION)"

          # ðŸ‘‡ Install Terraform via bash (keep this)
          - script: |
              set -e
              TF_VERSION=1.8.5
              curl -fsSL "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip" -o terraform.zip
              sudo unzip -o terraform.zip -d /usr/local/bin
              rm terraform.zip
              terraform -version
            displayName: "Install Terraform CLI"

          - script: |
              cd $(TF_ROOT)
              terraform init -backend=false
              terraform validate
            displayName: "Terraform validate (evidence storage)"

          - script: |
              pip install -r platform/devsecops/python/requirements-dev.txt
              python -m py_compile lab_platform/identity_gateway/policy_engine.py
            displayName: "Python sanity compile (identity gateway)"

  - stage: Security
    displayName: "IaC Security Scan"
    dependsOn: Validate
    jobs:
      - job: security
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self

          - task: UsePythonVersion@0
            inputs:
              versionSpec: "$(PYTHON_VERSION)"

          - script: |
              pip install checkov
              checkov -d $(TF_ROOT)
            displayName: "Run Checkov on Terraform"

  - stage: PolicyCheck
    displayName: "OPA Guardrails"
    dependsOn: Security
    jobs:
      - job: policy_check
        pool:
          vmImage: "ubuntu-latest"
        variables:
          TF_VERSION: "1.8.5"
          OPA_VERSION: "0.65.0"
        steps:
          - checkout: self

          # ---- Install Terraform ----
          - script: |
              set -e
              curl -fsSL "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip" -o terraform.zip
              sudo unzip -o terraform.zip -d /usr/local/bin
              rm terraform.zip
              terraform -version
            displayName: "Install Terraform CLI"

          # ---- Install OPA ----
          - script: |
              set -e
              curl -L -o opa "https://openpolicyagent.org/downloads/v${OPA_VERSION}/opa_linux_amd64_static"
              chmod +x ./opa
              sudo mv opa /usr/local/bin/opa
              opa version
            displayName: "Install OPA CLI"

          # ---- Terraform plan under Azure SPN context ----
          - task: AzureCLI@2
            displayName: "Terraform plan (generate tfplan.json)"
            inputs:
              azureSubscription: "mcp-azure-terraform-spn"   # your service connection
              scriptType: bash
              scriptLocation: inlineScript
              addSpnToEnvironment: true
              inlineScript: |
                set -e

                # Export SPN into ARM_* env vars for azurerm provider
                export ARM_CLIENT_ID="$servicePrincipalId"
                export ARM_CLIENT_SECRET="$servicePrincipalKey"
                export ARM_TENANT_ID="$tenantId"
                export ARM_SUBSCRIPTION_ID="$subscriptionId"

                echo "service connection subscriptionId: '$subscriptionId'"
                echo "ARM_SUBSCRIPTION_ID: '$ARM_SUBSCRIPTION_ID'"

                cd $(TF_ROOT)

                terraform init -backend=false

                terraform plan -input=false -lock=false \
                  -var="subscription_id=ef83b64d-39a9-4b0f-af33-06968ebd9a0a" \
                  -var="tenant_id=0ff0f2e4-1bd5-4dca-bcc0-ea9dbaf4ea47" \
                  -var="resource_group_name=rg-rag-mcp-sec" \
                  -var="location=westus" \
                  -var="storage_account_name=ragmcpevidence001" \
                  -var="environment=dev" \
                  -var="user_assigned_identity_id=/subscriptions/ef83b64d-39a9-4b0f-af33-06968ebd9a0a/resourceGroups/rg-identities/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uai-evidence-lab" \
                  -var="cmk_key_vault_key_id=https://kv-security-ragmcp.vault.azure.net/keys/kv-evidence-key" \
                  -var="private_endpoint_subnet_id=/subscriptions/ef83b64d-39a9-4b0f-af33-06968ebd9a0a/resourceGroups/rg-rag-mcp-sec/providers/Microsoft.Network/virtualNetworks/vnet-rag-mcp-sec/subnets/snet-private-endpoints" \
                  -var="log_analytics_workspace_id=/subscriptions/ef83b64d-39a9-4b0f-af33-06968ebd9a0a/resourceGroups/rg-logs/providers/Microsoft.OperationalInsights/workspaces/law-evidence" \
                  -out=tfplan

                terraform show -json tfplan > terraform_plan.json

          # ---- OPA evaluation ----
          - script: |
              opa eval --format pretty \
                --input $(TF_ROOT)/terraform_plan.json \
                --data platform/governance/policies_as_code/opa/terraform_guardrails.rego \
                "data.terraform.guardrails.deny"
            displayName: "Evaluate OPA Terraform guardrails"

  - stage: Deploy
    displayName: "Deploy (manual)"
    dependsOn: PolicyCheck
    jobs:
      - job: deploy
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self

          # Install Terraform
          - script: |
              set -e
              TF_VERSION=1.8.5
              curl -fsSL "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip" -o terraform.zip
              sudo unzip -o terraform.zip -d /usr/local/bin
              rm terraform.zip
              terraform -version
            displayName: "Install Terraform CLI"

                # ðŸ” Azure login + Terraform import/apply using service connection
          - task: AzureCLI@2
            displayName: "Terraform import + apply"
            inputs:
              azureSubscription: "mcp-azure-terraform-spn"   # your existing service connection
              scriptType: bash
              scriptLocation: inlineScript
              addSpnToEnvironment: true
              inlineScript: |
                set -e

                # Wire service connection SP into Terraform env vars for azurerm provider
                export ARM_CLIENT_ID="$servicePrincipalId"
                export ARM_CLIENT_SECRET="$servicePrincipalKey"
                export ARM_TENANT_ID="$tenantId"
                export ARM_SUBSCRIPTION_ID="$subscriptionId"

                # ðŸ‘‡ Tell Terraform NOT to ever prompt
                export TF_INPUT=0
                export TF_CLI_ARGS="-input=false"

                # ðŸ‘‡ Feed ALL required TF variables so import/apply never ask for values
                export TF_VAR_subscription_id="ef83b64d-39a9-4b0f-af33-06968ebd9a0a"
                export TF_VAR_tenant_id="0ff0f2e4-1bd5-4dca-bcc0-ea9dbaf4ea47"

                export TF_VAR_resource_group_name="rg-rag-mcp-sec"
                export TF_VAR_location="westus"
                export TF_VAR_storage_account_name="ragmcpevidence001"
                export TF_VAR_environment="dev"

                export TF_VAR_user_assigned_identity_id="/subscriptions/ef83b64d-39a9-4b0f-af33-06968ebd9a0a/resourceGroups/rg-identities/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uai-evidence-lab"
                export TF_VAR_cmk_key_vault_key_id="https://kv-security-ragmcp.vault.azure.net/keys/kv-evidence-key"
                export TF_VAR_private_endpoint_subnet_id="/subscriptions/ef83b64d-39a9-4b0f-af33-06968ebd9a0a/resourceGroups/rg-rag-mcp-sec/providers/Microsoft.Network/virtualNetworks/vnet-rag-mcp-sec/subnets/snet-private-endpoints"
                export TF_VAR_log_analytics_workspace_id="/subscriptions/ef83b64d-39a9-4b0f-af33-06968ebd9a0a/resourceGroups/rg-logs/providers/Microsoft.OperationalInsights/workspaces/law-evidence"

                echo "Using ARM_SUBSCRIPTION_ID=$ARM_SUBSCRIPTION_ID"
                echo "Using TF_VAR_subscription_id=$TF_VAR_subscription_id"

                cd $(TF_ROOT)

                terraform init

                # ðŸ” Import storage account into state if it's not there yet
                if ! terraform state show azurerm_storage_account.evidence >/dev/null 2>&1; then
                  echo "State missing azurerm_storage_account.evidence â€“ importing existing resource..."
                  terraform import \
                    azurerm_storage_account.evidence \
                    "/subscriptions/ef83b64d-39a9-4b0f-af33-06968ebd9a0a/resourceGroups/rg-rag-mcp-sec/providers/Microsoft.Storage/storageAccounts/ragmcpevidence001"
                else
                  echo "azurerm_storage_account.evidence already in state â€“ skipping import."
                fi

                # âœ… Apply full config
                terraform apply -auto-approve


  - stage: Evidence
    displayName: "Generate Evidence Bundle"
    dependsOn: Deploy
    jobs:
      - job: evidence
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self

          - task: UsePythonVersion@0
            inputs:
              versionSpec: "$(PYTHON_VERSION)"

          - script: |
              python platform/devsecops/scripts/generate_evidence_report.py
            displayName: "Generate evidence report"

          - publish: platform/evidence
            artifact: evidence_bundle
            displayName: "Publish evidence bundle"
