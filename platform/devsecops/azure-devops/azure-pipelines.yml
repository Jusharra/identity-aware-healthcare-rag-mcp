trigger:
  branches:
    include:
      - main
      - feature/*

variables:
  TF_ROOT: "platform/devsecops/terraform/evidence_storage_azure"
  PYTHON_VERSION: "3.11"

stages:
  - stage: Validate
    displayName: "Validate Terraform & Python"
    jobs:
      - job: validate
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: "$(PYTHON_VERSION)"

          # ðŸ‘‡ Install Terraform via bash (keep this)
          - script: |
              set -e
              TF_VERSION=1.8.5
              curl -fsSL "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip" -o terraform.zip
              sudo unzip -o terraform.zip -d /usr/local/bin
              rm terraform.zip
              terraform -version
            displayName: "Install Terraform CLI"

          - script: |
              cd $(TF_ROOT)
              terraform init -backend=false
              terraform validate
            displayName: "Terraform validate (evidence storage)"

          - script: |
              pip install -r platform/devsecops/python/requirements-dev.txt
              python -m py_compile lab_platform/identity_gateway/policy_engine.py
            displayName: "Python sanity compile (identity gateway)"

  - stage: Security
    displayName: "IaC Security Scan"
    dependsOn: Validate
    jobs:
      - job: security
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self

          - task: UsePythonVersion@0
            inputs:
              versionSpec: "$(PYTHON_VERSION)"

          - script: |
              pip install checkov
              checkov -d $(TF_ROOT)
            displayName: "Run Checkov on Terraform"

  - stage: PolicyCheck
    displayName: "OPA Guardrails"
    dependsOn: Security
    jobs:
      - job: policy_check
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self

          # ---- Install Terraform ----
          - task: Bash@3
            displayName: "Install Terraform CLI"
            inputs:
              targetType: inline
              script: |
                set -e
                TF_VERSION=1.9.2
                curl -L "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip" -o terraform.zip
                sudo unzip terraform.zip -d /usr/local/bin
                rm terraform.zip
                terraform -version

          # ---- Install OPA ----
          - task: Bash@3
            displayName: "Install OPA CLI"
            inputs:
              targetType: inline
              script: |
                set -e
                OPA_VERSION=0.65.0
                curl -L -o opa "https://openpolicyagent.org/downloads/v${OPA_VERSION}/opa_linux_amd64_static"
                chmod +x ./opa
                sudo mv opa /usr/local/bin/opa
                opa version

          - script: |
              cd $(TF_ROOT)
              terraform init -backend=false
              terraform plan \
                -var="log_analytics_workspace_id=/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/rg-logs/providers/Microsoft.OperationalInsights/workspaces/law-evidence" \
                -out=tfplan
              terraform show -json tfplan > terraform_plan.json
            displayName: "Generate Terraform plan JSON"

          - script: |
              opa eval --format pretty \
                --input $(TF_ROOT)/terraform_plan.json \
                --data platform/governance/policies_as_code/opa/terraform_guardrails.rego \
                "data.terraform.guardrails.deny"
            displayName: "Evaluate OPA Terraform guardrails"

  - stage: Deploy
    displayName: "Deploy (manual)"
    dependsOn: PolicyCheck
    jobs:
      - job: deploy
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self

          # ---- Install Terraform ----
          - task: Bash@3
            displayName: "Install Terraform CLI"
            inputs:
              targetType: inline
              script: |
                set -e
                TF_VERSION=1.9.2
                curl -L "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip" -o terraform.zip
                sudo unzip terraform.zip -d /usr/local/bin
                rm terraform.zip
                terraform -version

          - script: |
              cd $(TF_ROOT)
              terraform init
              terraform apply -auto-approve
            displayName: "Terraform apply"
        # Manual approval gate in Azure DevOps UI
        # (configure environment with approvals)

  - stage: Evidence
    displayName: "Generate Evidence Bundle"
    dependsOn: Deploy
    jobs:
      - job: evidence
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self

          - task: UsePythonVersion@0
            inputs:
              versionSpec: "$(PYTHON_VERSION)"

          - script: |
              python platform/devsecops/scripts/generate_evidence_report.py
            displayName: "Generate evidence report"

          - publish: platform/evidence
            artifact: evidence_bundle
            displayName: "Publish evidence bundle"
