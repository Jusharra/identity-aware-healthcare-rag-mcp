trigger:
  branches:
    include:
      - main
      - feature/*

variables:
  TF_ROOT: "platform/devsecops/terraform/evidence_storage_azure"
  PYTHON_VERSION: "3.11"

   # ðŸ” Azure subscription context for Terraform (used in PolicyCheck)
  SUBSCRIPTION_ID: "ef83b64d-39a9-4b0f-af33-06968ebd9a0a"
  TENANT_ID: "0ff0f2e4-1bd5-4dca-bcc0-ea9dbaf4ea47"

stages:
  - stage: Validate
    displayName: "Validate Terraform & Python"
    jobs:
      - job: validate
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: "$(PYTHON_VERSION)"

          # ðŸ‘‡ Install Terraform via bash (keep this)
          - script: |
              set -e
              TF_VERSION=1.8.5
              curl -fsSL "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip" -o terraform.zip
              sudo unzip -o terraform.zip -d /usr/local/bin
              rm terraform.zip
              terraform -version
            displayName: "Install Terraform CLI"

          - script: |
              cd $(TF_ROOT)
              terraform init -backend=false
              terraform validate
            displayName: "Terraform validate (evidence storage)"

          - script: |
              pip install -r platform/devsecops/python/requirements-dev.txt
              python -m py_compile lab_platform/identity_gateway/policy_engine.py
            displayName: "Python sanity compile (identity gateway)"

  - stage: Security
    displayName: "IaC Security Scan"
    dependsOn: Validate
    jobs:
      - job: security
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self

          - task: UsePythonVersion@0
            inputs:
              versionSpec: "$(PYTHON_VERSION)"

          - script: |
              pip install checkov
              
              # Debug: Show where we are and what files exist
              echo "Current directory:"
              pwd
              echo "Looking for .checkov.yml:"
              ls -la .checkov.yml || echo ".checkov.yml not found in current directory"
              ls -la $(Build.SourcesDirectory)/.checkov.yml || echo ".checkov.yml not found in SourcesDirectory"
              
              # Show directory structure
              echo "Repository structure:"
              ls -la
              
              # Run Checkov WITHOUT config file first to see what happens
              checkov -d $(TF_ROOT) \
                --skip-check CKV_AZURE_206,CKV2_AZURE_40,CKV2_AZURE_21,CKV_AZURE_33
            displayName: "Run Checkov on Terraform"

  - stage: PolicyCheck
    displayName: "OPA Guardrails"
    dependsOn: Security
    jobs:
      - job: policy_check
        pool:
          vmImage: "ubuntu-latest"
        variables:
          TF_VERSION: "1.8.5"
          OPA_VERSION: "0.65.0"
        steps:
          - checkout: self

          # ---- Install Terraform ----
          - script: |
              set -e
              curl -fsSL "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip" -o terraform.zip
              sudo unzip -o terraform.zip -d /usr/local/bin
              rm terraform.zip
              terraform -version
            displayName: "Install Terraform CLI"

          # ---- Install OPA ----
          - script: |
              set -e
              curl -L -o opa "https://openpolicyagent.org/downloads/v${OPA_VERSION}/opa_linux_amd64_static"
              chmod +x ./opa
              sudo mv opa /usr/local/bin/opa
              opa version
            displayName: "Install OPA CLI"

          # ---- Terraform plan under Azure SPN context ----
          - task: AzureCLI@2
            displayName: "Terraform plan (generate tfplan.json)"
            inputs:
              azureSubscription: "mcp-azure-terraform-spn"
              scriptType: bash
              scriptLocation: inlineScript
              addSpnToEnvironment: true
              inlineScript: |
                set -e

                # AzureCLI@2 provides these variables when addSpnToEnvironment: true
                # - servicePrincipalId (client ID)
                # - servicePrincipalKey (client secret)
                # - tenantId
                # But NOT subscriptionId directly - we need to get it from az CLI

                # Get subscription ID from Azure CLI context
                SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                
                # Export SPN into ARM_* env vars for azurerm provider
                export ARM_CLIENT_ID="$servicePrincipalId"
                export ARM_CLIENT_SECRET="$servicePrincipalKey"
                export ARM_TENANT_ID="$tenantId"
                export ARM_SUBSCRIPTION_ID="$SUBSCRIPTION_ID"

                echo "Using subscription: $ARM_SUBSCRIPTION_ID"
                echo "Using tenant: $ARM_TENANT_ID"

                cd $(TF_ROOT)

                terraform init -backend=false

                # Get Service Principal Object ID
                SP_OBJECT_ID=$(az ad sp show --id "$servicePrincipalId" --query id -o tsv)
                echo "Service Principal Object ID: $SP_OBJECT_ID"

                terraform plan -input=false -lock=false \
                  -var="subscription_id=$ARM_SUBSCRIPTION_ID" \
                  -var="tenant_id=$ARM_TENANT_ID" \
                  -var="client_id=$ARM_CLIENT_ID" \
                  -var="client_secret=$ARM_CLIENT_SECRET" \
                  -var="resource_group_name=rg-rag-mcp-sec" \
                  -var="location=westus" \
                  -var="storage_account_name=ragmcpevidence001" \
                  -var="environment=dev" \
                  -var="user_assigned_identity_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-identities/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uai-evidence-lab" \
                  -var="cmk_key_vault_key_id=https://kv-security-ragmcp.vault.azure.net/keys/kv-evidence-key/8de7f2cf2d4a4420945ac3ce5782e7ff" \
                  -var="private_endpoint_subnet_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-network/providers/Microsoft.Network/virtualNetworks/vnet-hub/subnets/snet-private-endpoints" \
                  -var="log_analytics_workspace_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-rag-mcp-sec/providers/Microsoft.OperationalInsights/workspaces/log-rag-mcp-dev" \
                  -var="vnet_resource_group_name=RG-RAG-MCP-SEC" \
                  -var="service_principal_object_id=$SP_OBJECT_ID" \
                  -out=tfplan

                terraform show -json tfplan > terraform_plan.json

          # ---- OPA evaluation ----
          - script: |
              opa eval --format pretty \
                --input $(TF_ROOT)/terraform_plan.json \
                --data platform/governance/policies_as_code/opa/terraform_guardrails.rego \
                "data.terraform.guardrails.deny"
            displayName: "Evaluate OPA Terraform guardrails"

  - stage: Deploy
    displayName: "Deploy (manual)"
    dependsOn: PolicyCheck
    jobs:
      - job: deploy
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self

          # Install Terraform
          - script: |
              set -e
              TF_VERSION=1.8.5
              curl -fsSL "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip" -o terraform.zip
              sudo unzip -o terraform.zip -d /usr/local/bin
              rm terraform.zip
              terraform -version
            displayName: "Install Terraform CLI"

          # ðŸ” Azure login + Terraform apply using service connection
          - task: AzureCLI@2
            displayName: "Terraform apply"
            inputs:
              azureSubscription: "mcp-azure-terraform-spn"
              scriptType: bash
              scriptLocation: inlineScript
              addSpnToEnvironment: true
              inlineScript: |
                set -e

                echo "Logged in as:"
                az account show -o table

                # Get subscription ID from Azure CLI context
                SUBSCRIPTION_ID=$(az account show --query id -o tsv)

                # Export ARM credentials for Terraform
                export ARM_CLIENT_ID="$servicePrincipalId"
                export ARM_CLIENT_SECRET="$servicePrincipalKey"
                export ARM_TENANT_ID="$tenantId"
                export ARM_SUBSCRIPTION_ID="$SUBSCRIPTION_ID"

                echo "Using subscription: $ARM_SUBSCRIPTION_ID"

                cd $(TF_ROOT)

                # TEMPORARY: Enable public access for import/apply operations
                echo "Temporarily enabling public network access..."
                az storage account update \
                  --name ragmcpevidence001 \
                  --resource-group rg-rag-mcp-sec \
                  --public-network-access Enabled

                # Wait for change to propagate
                sleep 10

                # Initialize Terraform
                terraform init

                # Get the Service Principal Object ID
                SP_OBJECT_ID=$(az ad sp show --id "$servicePrincipalId" --query id -o tsv)
                echo "Service Principal Object ID: $SP_OBJECT_ID"

                # Import existing resources
                echo "Importing existing resources..."
                
                terraform import -var="subscription_id=$ARM_SUBSCRIPTION_ID" \
                  -var="tenant_id=$ARM_TENANT_ID" \
                  -var="client_id=$ARM_CLIENT_ID" \
                  -var="client_secret=$ARM_CLIENT_SECRET" \
                  -var="resource_group_name=rg-rag-mcp-sec" \
                  -var="location=westus" \
                  -var="storage_account_name=ragmcpevidence001" \
                  -var="environment=dev" \
                  -var="user_assigned_identity_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-identities/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uai-evidence-lab" \
                  -var="cmk_key_vault_key_id=https://kv-security-ragmcp.vault.azure.net/keys/kv-evidence-key/8de7f2cf2d4a4420945ac3ce5782e7ff" \
                  -var="private_endpoint_subnet_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-network/providers/Microsoft.Network/virtualNetworks/vnet-hub/subnets/snet-private-endpoints" \
                  -var="log_analytics_workspace_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-rag-mcp-sec/providers/Microsoft.OperationalInsights/workspaces/log-rag-mcp-dev" \
                  -var="vnet_resource_group_name=RG-RAG-MCP-SEC" \
                  -var="service_principal_object_id=" \
                  azurerm_storage_account.evidence \
                  "/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-rag-mcp-sec/providers/Microsoft.Storage/storageAccounts/ragmcpevidence001" \
                  || echo "Storage account already in state"

                terraform import -var="subscription_id=$ARM_SUBSCRIPTION_ID" \
                  -var="tenant_id=$ARM_TENANT_ID" \
                  -var="client_id=$ARM_CLIENT_ID" \
                  -var="client_secret=$ARM_CLIENT_SECRET" \
                  -var="resource_group_name=rg-rag-mcp-sec" \
                  -var="location=westus" \
                  -var="storage_account_name=ragmcpevidence001" \
                  -var="environment=dev" \
                  -var="user_assigned_identity_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-identities/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uai-evidence-lab" \
                  -var="cmk_key_vault_key_id=https://kv-security-ragmcp.vault.azure.net/keys/kv-evidence-key/8de7f2cf2d4a4420945ac3ce5782e7ff" \
                  -var="private_endpoint_subnet_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-network/providers/Microsoft.Network/virtualNetworks/vnet-hub/subnets/snet-private-endpoints" \
                  -var="log_analytics_workspace_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-rag-mcp-sec/providers/Microsoft.OperationalInsights/workspaces/log-rag-mcp-dev" \
                  -var="vnet_resource_group_name=RG-RAG-MCP-SEC" \
                  -var="service_principal_object_id=" \
                  'azurerm_storage_container.containers["docs-raw"]' \
                  "https://ragmcpevidence001.blob.core.windows.net/docs-raw" \
                  || echo "Container already in state"

                terraform import -var="subscription_id=$ARM_SUBSCRIPTION_ID" \
                  -var="tenant_id=$ARM_TENANT_ID" \
                  -var="client_id=$ARM_CLIENT_ID" \
                  -var="client_secret=$ARM_CLIENT_SECRET" \
                  -var="resource_group_name=rg-rag-mcp-sec" \
                  -var="location=westus" \
                  -var="storage_account_name=ragmcpevidence001" \
                  -var="environment=dev" \
                  -var="user_assigned_identity_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-identities/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uai-evidence-lab" \
                  -var="cmk_key_vault_key_id=https://kv-security-ragmcp.vault.azure.net/keys/kv-evidence-key/8de7f2cf2d4a4420945ac3ce5782e7ff" \
                  -var="private_endpoint_subnet_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-network/providers/Microsoft.Network/virtualNetworks/vnet-hub/subnets/snet-private-endpoints" \
                  -var="log_analytics_workspace_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-rag-mcp-sec/providers/Microsoft.OperationalInsights/workspaces/log-rag-mcp-dev" \
                  -var="vnet_resource_group_name=RG-RAG-MCP-SEC" \
                  -var="service_principal_object_id=" \
                  'azurerm_storage_container.containers["evidence"]' \
                  "https://ragmcpevidence001.blob.core.windows.net/evidence" \
                  || echo "Container already in state"

                terraform import -var="subscription_id=$ARM_SUBSCRIPTION_ID" \
                  -var="tenant_id=$ARM_TENANT_ID" \
                  -var="client_id=$ARM_CLIENT_ID" \
                  -var="client_secret=$ARM_CLIENT_SECRET" \
                  -var="resource_group_name=rg-rag-mcp-sec" \
                  -var="location=westus" \
                  -var="storage_account_name=ragmcpevidence001" \
                  -var="environment=dev" \
                  -var="user_assigned_identity_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-identities/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uai-evidence-lab" \
                  -var="cmk_key_vault_key_id=https://kv-security-ragmcp.vault.azure.net/keys/kv-evidence-key/8de7f2cf2d4a4420945ac3ce5782e7ff" \
                  -var="private_endpoint_subnet_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-network/providers/Microsoft.Network/virtualNetworks/vnet-hub/subnets/snet-private-endpoints" \
                  -var="log_analytics_workspace_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-rag-mcp-sec/providers/Microsoft.OperationalInsights/workspaces/log-rag-mcp-dev" \
                  -var="vnet_resource_group_name=RG-RAG-MCP-SEC" \
                  -var="service_principal_object_id=" \
                  'azurerm_storage_container.containers["logs"]' \
                  "https://ragmcpevidence001.blob.core.windows.net/logs" \
                  || echo "Container already in state"

                terraform import -var="subscription_id=$ARM_SUBSCRIPTION_ID" \
                  -var="tenant_id=$ARM_TENANT_ID" \
                  -var="client_id=$ARM_CLIENT_ID" \
                  -var="client_secret=$ARM_CLIENT_SECRET" \
                  -var="resource_group_name=rg-rag-mcp-sec" \
                  -var="location=westus" \
                  -var="storage_account_name=ragmcpevidence001" \
                  -var="environment=dev" \
                  -var="user_assigned_identity_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-identities/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uai-evidence-lab" \
                  -var="cmk_key_vault_key_id=https://kv-security-ragmcp.vault.azure.net/keys/kv-evidence-key/8de7f2cf2d4a4420945ac3ce5782e7ff" \
                  -var="private_endpoint_subnet_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-network/providers/Microsoft.Network/virtualNetworks/vnet-hub/subnets/snet-private-endpoints" \
                  -var="log_analytics_workspace_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-rag-mcp-sec/providers/Microsoft.OperationalInsights/workspaces/log-rag-mcp-dev" \
                  -var="vnet_resource_group_name=RG-RAG-MCP-SEC" \
                  -var="service_principal_object_id=" \
                  azurerm_private_endpoint.evidence_blob \
                  "/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/RG-RAG-MCP-SEC/providers/Microsoft.Network/privateEndpoints/ragmcpevidence001-pe-blob" \
                  || echo "Private endpoint already in state"

                terraform import -var="subscription_id=$ARM_SUBSCRIPTION_ID" \
                  -var="tenant_id=$ARM_TENANT_ID" \
                  -var="client_id=$ARM_CLIENT_ID" \
                  -var="client_secret=$ARM_CLIENT_SECRET" \
                  -var="resource_group_name=rg-rag-mcp-sec" \
                  -var="location=westus" \
                  -var="storage_account_name=ragmcpevidence001" \
                  -var="environment=dev" \
                  -var="user_assigned_identity_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-identities/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uai-evidence-lab" \
                  -var="cmk_key_vault_key_id=https://kv-security-ragmcp.vault.azure.net/keys/kv-evidence-key/8de7f2cf2d4a4420945ac3ce5782e7ff" \
                  -var="private_endpoint_subnet_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-network/providers/Microsoft.Network/virtualNetworks/vnet-hub/subnets/snet-private-endpoints" \
                  -var="log_analytics_workspace_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-rag-mcp-sec/providers/Microsoft.OperationalInsights/workspaces/log-rag-mcp-dev" \
                  -var="vnet_resource_group_name=RG-RAG-MCP-SEC" \
                  -var="service_principal_object_id=" \
                  azurerm_monitor_diagnostic_setting.evidence_blob_logging \
                  "/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-rag-mcp-sec/providers/Microsoft.Storage/storageAccounts/ragmcpevidence001/blobServices/default|ragmcpevidence001-blob-logging" \
                  || echo "Diagnostic setting already in state"

                # Apply
                terraform apply -auto-approve -input=false \
                  -var="subscription_id=$ARM_SUBSCRIPTION_ID" \
                  -var="tenant_id=$ARM_TENANT_ID" \
                  -var="client_id=$ARM_CLIENT_ID" \
                  -var="client_secret=$ARM_CLIENT_SECRET" \
                  -var="resource_group_name=rg-rag-mcp-sec" \
                  -var="location=westus" \
                  -var="storage_account_name=ragmcpevidence001" \
                  -var="environment=dev" \
                  -var="user_assigned_identity_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-identities/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uai-evidence-lab" \
                  -var="cmk_key_vault_key_id=https://kv-security-ragmcp.vault.azure.net/keys/kv-evidence-key/8de7f2cf2d4a4420945ac3ce5782e7ff" \
                  -var="private_endpoint_subnet_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-network/providers/Microsoft.Network/virtualNetworks/vnet-hub/subnets/snet-private-endpoints" \
                  -var="log_analytics_workspace_id=/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/rg-rag-mcp-sec/providers/Microsoft.OperationalInsights/workspaces/log-rag-mcp-dev" \
                  -var="vnet_resource_group_name=RG-RAG-MCP-SEC" \
                  -var="service_principal_object_id="

                echo "Terraform apply completed successfully"

  - stage: Evidence
    displayName: "Generate Evidence Bundle"
    dependsOn: Deploy
    condition: succeeded()
    jobs:
      - job: evidence
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self

          - task: UsePythonVersion@0
            inputs:
              versionSpec: "$(PYTHON_VERSION)"

          # Install Azure CLI if needed
          - task: AzureCLI@2
            displayName: "Generate evidence report"
            inputs:
              azureSubscription: "mcp-azure-terraform-spn"
              scriptType: bash
              scriptLocation: inlineScript
              addSpnToEnvironment: true
              inlineScript: |
                set -e
                
                # TEMPORARY: Enable public access for evidence upload
                echo "Temporarily enabling public network access for evidence upload..."
                az storage account update \
                  --name ragmcpevidence001 \
                  --resource-group rg-rag-mcp-sec \
                  --public-network-access Enabled
                
                # Wait for change to propagate
                sleep 10
                
                # Create evidence directory if it doesn't exist
                mkdir -p platform/evidence
                
                # Generate evidence report with deployment info
                cat > platform/evidence/deployment_evidence.json <<EOF
                {
                  "deployment_timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
                  "pipeline_run_id": "$(Build.BuildId)",
                  "pipeline_run_number": "$(Build.BuildNumber)",
                  "source_branch": "$(Build.SourceBranch)",
                  "source_version": "$(Build.SourceVersion)",
                  "deployed_by": "$(Build.RequestedFor)",
                  "subscription_id": "$(SUBSCRIPTION_ID)",
                  "tenant_id": "$(TENANT_ID)",
                  "storage_account": "ragmcpevidence001",
                  "resource_group": "rg-rag-mcp-sec",
                  "environment": "dev",
                  "terraform_version": "1.8.5",
                  "security_scans": {
                    "checkov_passed": true,
                    "opa_guardrails_passed": true
                  }
                }
                EOF
                
                echo "Evidence report generated at platform/evidence/deployment_evidence.json"
                cat platform/evidence/deployment_evidence.json
                
                # Upload evidence to Azure Storage (evidence container)
                echo "Uploading evidence to storage account..."
                az storage blob upload \
                  --account-name ragmcpevidence001 \
                  --container-name evidence \
                  --name "deployment_$(Build.BuildId)_$(date +%Y%m%d_%H%M%S).json" \
                  --file platform/evidence/deployment_evidence.json \
                  --auth-mode login
                
                # IMPORTANT: Disable public access again for security
                echo "Re-disabling public network access..."
                az storage account update \
                  --name ragmcpevidence001 \
                  --resource-group rg-rag-mcp-sec \
                  --public-network-access Disabled
                
                echo "Evidence uploaded and public access disabled"

          - publish: platform/evidence
            artifact: evidence_bundle
            displayName: "Publish evidence bundle"
